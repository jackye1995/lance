# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: Codex Backport PR

on:
  workflow_dispatch:
    inputs:
      pr_urls:
        description: "Comma-separated list of PR URLs to backport in order (e.g., https://github.com/lance-format/lance/pull/1234,https://github.com/lance-format/lance/pull/5678)"
        required: true
        type: string
      release_branch:
        description: "Release branch to backport to (e.g., release/v2.0)"
        required: true
        type: string
      guidelines:
        description: "Additional guidelines for the backport (optional)"
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: read

jobs:
  backport:
    runs-on: warp-ubuntu-latest-x64-4x
    timeout-minutes: 60
    env:
      CC: clang
      CXX: clang++
    steps:
      - name: Show inputs
        run: |
          echo "pr_urls = ${{ inputs.pr_urls }}"
          echo "release_branch = ${{ inputs.release_branch }}"
          echo "guidelines = ${{ inputs.guidelines }}"

      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Codex CLI
        run: npm install -g @openai/codex

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy, rustfmt

      - uses: rui314/setup-mold@v1

      - uses: Swatinem/rust-cache@v2

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler libssl-dev

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          pip install maturin ruff pytest pyarrow pandas polars

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: maven

      - name: Configure git user
        run: |
          git config user.name "lance-community"
          git config user.email "community@lance.org"

      - name: Run Codex to backport PRs
        env:
          PR_URLS: ${{ inputs.pr_urls }}
          RELEASE_BRANCH: ${{ inputs.release_branch }}
          GUIDELINES: ${{ inputs.guidelines }}
          GITHUB_TOKEN: ${{ secrets.LANCE_RELEASE_TOKEN }}
          GH_TOKEN: ${{ secrets.LANCE_RELEASE_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.CODEX_TOKEN }}
        run: |
          set -euo pipefail

          cat <<EOF >/tmp/codex-prompt.txt
          You are running inside the lance repository on a GitHub Actions runner. Your task is to backport one or more merged PRs to a release branch.

          Input parameters:
          - PR URLs (comma-separated): ${PR_URLS}
          - Release branch: ${RELEASE_BRANCH}
          - Additional guidelines: ${GUIDELINES:-"None provided"}

          Follow these steps exactly:

          1. Parse the comma-separated PR URLs into a list. Split by comma and trim whitespace. The URL format is https://github.com/lance-format/lance/pull/<number>.

          2. Verify the release branch exists with "git ls-remote --heads origin ${RELEASE_BRANCH}". If it doesn't exist, exit with an error.

          3. Checkout the release branch: "git checkout ${RELEASE_BRANCH}" and pull latest: "git pull origin ${RELEASE_BRANCH}".

          4. For each PR URL in the list (in the given order):
             a. Extract the PR number from the URL.
             b. Use "gh pr view <number> --json state,mergeCommit,title,number" to verify the PR is merged. If not merged (state != "MERGED"), exit with an error.
             c. Store the PR title and merge commit SHA.

          5. Create a new branch for the backport. If there's only one PR, use "backport/pr-<number>-to-${RELEASE_BRANCH//\//-}". If multiple PRs, use "backport/pr-<first_number>-and-more-to-${RELEASE_BRANCH//\//-}".

          6. For each PR in order, cherry-pick the merge commit: "git cherry-pick -m 1 <merge_commit_sha>".
             - If there are conflicts, try to resolve them. Inspect conflicting files with "git status" and "git diff".
             - For simple conflicts, fix them and continue with "git add -A && git cherry-pick --continue".
             - If conflicts are too complex to resolve automatically, abort and exit with a clear error message.

          7. Run "cargo fmt --all" to ensure formatting is correct.

          8. Run "cargo clippy --workspace --tests --benches -- -D warnings" to check for issues. Fix any warnings and rerun until clean.

          9. Run ONLY the tests related to the changes in these PRs:
             - Use "git diff --name-only ${RELEASE_BRANCH}..HEAD" to see which files were changed across all cherry-picks.
             - For Rust changes: Run tests for the affected crates only (e.g., "cargo test -p lance-core" if lance-core files changed).
             - For Python changes (python/** files): Build with "cd python && maturin develop" then run "pytest" on the specific test files that were modified, or related test files.
             - For Java changes (java/** files): Run "cd java && mvn test" for the affected modules.
             - If test files themselves were modified, run those specific tests.
             - Do NOT run the full test suite - only run tests related to the changed files.

          10. If additional guidelines are provided, follow them as well when making decisions or resolving issues.

          11. Stage any additional changes with "git add -A" and amend the last commit if needed: "git commit --amend --no-edit".

          12. Push the branch: "git push origin <branch_name>". If the remote branch exists, delete it first with "gh api -X DELETE repos/lance-format/lance/git/refs/heads/<branch_name>" then push. Do NOT use "git push --force" or "git push -f".

          13. Create a pull request targeting "${RELEASE_BRANCH}":
              - If single PR: Title should be the same as the original PR title.
              - If multiple PRs: Title should be "Backport PRs to ${RELEASE_BRANCH}" or combine the titles meaningfully.
              - First, write the PR body to /tmp/pr-body.md using a heredoc (cat <<'PREOF' > /tmp/pr-body.md). The body should list all backported PRs with their URLs:
                "Backport of:
                - <PR_URL_1>
                - <PR_URL_2>
                ...

                This PR backports the changes from the original PRs to the ${RELEASE_BRANCH} branch."
              - Then run "gh pr create --base ${RELEASE_BRANCH} --title '<title>' --body-file /tmp/pr-body.md".

          14. Display the new PR URL, "git status --short", and a summary of what was done.

          Constraints:
          - Use bash commands for all operations.
          - Do not merge the PR.
          - Do not modify GitHub workflow files.
          - If any command fails, diagnose and attempt to fix the issue instead of aborting immediately.
          - env "GH_TOKEN" is available, use "gh" tools for GitHub-related operations.
          EOF

          printenv OPENAI_API_KEY | codex login --with-api-key
          codex --config shell_environment_policy.ignore_default_excludes=true exec --dangerously-bypass-approvals-and-sandbox "$(cat /tmp/codex-prompt.txt)"
